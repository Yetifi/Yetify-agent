# Yetify Backend Database Schema

## Overview
Yetify uses MongoDB as its primary database with Mongoose ODM for schema definition and validation. The database supports multi-chain DeFi strategy management with comprehensive user tracking and performance monitoring.

## Database Configuration

### Connection Details
- **Database Name**: `yetify`  
- **Default URI**: `mongodb://localhost:27017/yetify`
- **Production URI**: Set via `MONGODB_URI` environment variable
- **Connection Options**:
  - `maxPoolSize`: 10
  - `serverSelectionTimeoutMS`: 5000
  - `socketTimeoutMS`: 45000
  - `retryWrites`: true
  - `retryReads`: true

## Collections Overview

### 1. Users Collection (`users`)

Stores user account information and preferences.

```javascript
{
  _id: ObjectId,
  walletAddress: String,      // Unique wallet identifier
  walletType: String,         // Wallet provider type
  preferences: {
    riskTolerance: String,
    preferredChains: [String],
    notificationsEnabled: Boolean,
    autoRebalancing: Boolean
  },
  strategies: [ObjectId],     // References to Strategy documents
  createdAt: Date,
  lastActive: Date,
  totalInvested: Number,
  totalReturns: Number,
  updatedAt: Date
}
```

#### User Schema Fields

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `walletAddress` | String | Yes | Unique wallet address (e.g., 0x123...abc) |
| `walletType` | String | Yes | Wallet type: 'metamask', 'near', 'walletconnect' |
| `preferences.riskTolerance` | String | No | Risk level: 'low', 'medium', 'high' (default: 'medium') |
| `preferences.preferredChains` | Array | No | Preferred blockchain networks |
| `preferences.notificationsEnabled` | Boolean | No | Email/push notifications (default: true) |
| `preferences.autoRebalancing` | Boolean | No | Automatic portfolio rebalancing (default: false) |
| `strategies` | Array | No | Array of Strategy ObjectId references |
| `createdAt` | Date | No | Account creation timestamp (auto-generated) |
| `lastActive` | Date | No | Last login/activity timestamp (default: now) |
| `totalInvested` | Number | No | Total USD invested across all strategies (default: 0) |
| `totalReturns` | Number | No | Total USD returns across all strategies (default: 0) |

#### User Indexes
```javascript
// Primary indexes
{ walletAddress: 1 }          // Unique index
{ lastActive: -1 }            // Performance index for active user queries
```

### 2. Strategies Collection (`strategies`)

Stores DeFi investment strategies generated by AI and their execution details.

```javascript
{
  _id: ObjectId,
  id: String,                 // Unique strategy identifier
  userId: ObjectId,           // Reference to User document
  goal: String,               // Human-readable strategy goal
  prompt: String,             // Original user prompt/request
  chains: [String],           // Target blockchain networks
  protocols: [String],        // DeFi protocols to use
  steps: [{
    action: String,           // Action type: 'deposit', 'stake', 'yield_farm', etc.
    protocol: String,         // Target protocol name
    asset: String,            // Asset symbol (e.g., 'USDC', 'NEAR')
    amount: String,           // Amount to invest
    expectedApy: Number,      // Expected annual percentage yield
    riskScore: Number,        // Risk score 1-10
    gasEstimate: String,      // Estimated gas costs
    dependencies: [String]    // Step dependencies
  }],
  riskLevel: String,          // Overall risk: 'Low', 'Medium', 'High'
  status: String,             // Current status
  estimatedApy: Number,       // Estimated annual percentage yield
  estimatedTvl: String,       // Estimated total value locked
  actualApy: Number,          // Actual APY (after execution)
  actualTvl: Number,          // Actual TVL (after execution)
  executionTime: String,      // Time to execute strategy
  gasEstimate: {
    ethereum: String,
    near: String,
    arbitrum: String
  },
  confidence: Number,         // AI confidence score 0-100
  reasoning: String,          // AI reasoning for strategy
  warnings: [String],         // Strategy warnings and risks
  executionHistory: [{
    timestamp: Date,
    action: String,
    status: String,           // 'pending', 'success', 'failed'
    transactionHash: String,
    gasUsed: String,
    error: String
  }],
  performance: {
    totalInvested: Number,
    currentValue: Number,
    totalReturns: Number,
    roi: Number,              // Return on investment percentage
    lastUpdated: Date
  },
  createdAt: Date,
  updatedAt: Date
}
```

#### Strategy Schema Fields

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `id` | String | Yes | Unique strategy identifier (e.g., 'strat_1642680600000') |
| `userId` | ObjectId | Yes | Reference to user who owns this strategy |
| `goal` | String | Yes | Human-readable strategy objective |
| `prompt` | String | Yes | Original user input prompt |
| `chains` | Array | Yes | Target blockchain networks (e.g., ['Ethereum', 'NEAR']) |
| `protocols` | Array | Yes | DeFi protocols to utilize (e.g., ['Uniswap', 'Aave']) |
| `steps` | Array | Yes | Ordered execution steps for the strategy |
| `steps.action` | String | Yes | Action type: 'deposit', 'stake', 'yield_farm', 'provide_liquidity', 'leverage', 'bridge' |
| `steps.protocol` | String | Yes | Target DeFi protocol name |
| `steps.asset` | String | Yes | Asset symbol or pair (e.g., 'USDC', 'ETH-USDC') |
| `steps.expectedApy` | Number | No | Expected annual percentage yield |
| `steps.riskScore` | Number | No | Risk assessment score (1-10 scale) |
| `riskLevel` | String | Yes | Overall strategy risk: 'Low', 'Medium', 'High' |
| `status` | String | No | Current status: 'draft', 'active', 'paused', 'completed', 'failed' |
| `estimatedApy` | Number | Yes | Estimated annual percentage yield |
| `estimatedTvl` | String | Yes | Estimated total value locked |
| `confidence` | Number | No | AI confidence in strategy success (0-100) |
| `reasoning` | String | No | AI-generated explanation of strategy choices |
| `warnings` | Array | No | Array of risk warnings and considerations |
| `performance.totalInvested` | Number | No | Total amount invested (USD) |
| `performance.currentValue` | Number | No | Current portfolio value (USD) |
| `performance.totalReturns` | Number | No | Total returns earned (USD) |
| `performance.roi` | Number | No | Return on investment percentage |

#### Strategy Indexes
```javascript
{ userId: 1, status: 1 }      // Composite index for user strategies by status
{ createdAt: -1 }             // Time-based sorting
{ id: 1 }                     // Unique strategy ID lookups
```

### 3. Protocols Collection (`protocols`)

Stores DeFi protocol information for strategy generation and risk assessment.

```javascript
{
  _id: ObjectId,
  id: String,                 // Unique protocol identifier
  name: String,               // Protocol display name
  chain: String,              // Primary blockchain network
  category: String,           // Protocol category
  tvl: Number,                // Total value locked (USD)
  apy: Number,                // Current annual percentage yield
  riskScore: Number,          // Risk assessment (1-10)
  url: String,                // Protocol website URL
  description: String,        // Protocol description
  tokens: [String],           // Supported tokens
  auditStatus: String,        // Security audit status
  isActive: Boolean,          // Protocol operational status
  lastUpdated: Date,          // Last data update timestamp
  createdAt: Date,
  updatedAt: Date
}
```

#### Protocol Schema Fields

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `id` | String | Yes | Unique protocol identifier (e.g., 'uniswap-v3') |
| `name` | String | Yes | Human-readable protocol name (e.g., 'Uniswap V3') |
| `chain` | String | Yes | Primary blockchain network (e.g., 'Ethereum', 'NEAR') |
| `category` | String | Yes | Protocol type: 'lending', 'dex', 'yield_farming', 'staking', 'derivatives' |
| `tvl` | Number | Yes | Total value locked in USD |
| `apy` | Number | Yes | Current annual percentage yield |
| `riskScore` | Number | Yes | Risk assessment score (1=lowest risk, 10=highest risk) |
| `url` | String | No | Official protocol website |
| `description` | String | No | Brief protocol description |
| `tokens` | Array | No | Array of supported token symbols |
| `auditStatus` | String | Yes | Security audit status: 'audited', 'unaudited', 'partially_audited' |
| `isActive` | Boolean | No | Whether protocol is operational (default: true) |
| `lastUpdated` | Date | No | Timestamp of last data refresh |

#### Protocol Indexes
```javascript
{ chain: 1, category: 1 }     // Filter by chain and protocol type
{ tvl: -1 }                   // Sort by total value locked
{ id: 1 }                     // Unique protocol lookups
```

## Relationships

### User → Strategies (One-to-Many)
- Each user can have multiple strategies
- Strategies reference users via `userId` field
- User document contains array of strategy ObjectIds for quick lookup

```javascript
// Query user with strategies
db.users.aggregate([
  { $match: { walletAddress: "0x123...abc" } },
  { $lookup: {
      from: "strategies",
      localField: "_id", 
      foreignField: "userId",
      as: "userStrategies"
  }}
])
```

### Strategies → Protocols (Many-to-Many)
- Strategies reference protocols by name in `protocols` and `steps.protocol` fields
- No direct foreign key relationship (protocols identified by name/id)
- Join performed at application level for real-time protocol data

## Data Types and Validation

### Mongoose Schema Validation
```javascript
// Risk tolerance validation
riskTolerance: {
  type: String,
  enum: ['low', 'medium', 'high'],
  default: 'medium'
}

// Wallet type validation  
walletType: {
  type: String,
  enum: ['metamask', 'near', 'walletconnect'],
  required: true
}

// Strategy status validation
status: {
  type: String,
  enum: ['draft', 'active', 'paused', 'completed', 'failed'],
  default: 'draft'
}
```

### Custom Validation Rules
- `walletAddress`: Must be unique across all users
- `confidence`: Must be between 0-100
- `riskScore`: Must be between 1-10
- `roi`: Calculated field (totalReturns / totalInvested * 100)

## Performance Considerations

### Indexing Strategy
```javascript
// Compound indexes for common query patterns
{ userId: 1, status: 1 }      // User strategies by status
{ chain: 1, category: 1 }     // Protocol filtering
{ createdAt: -1 }             // Time-based sorting
{ lastActive: -1 }            // Active user identification

// Text indexes for search functionality
{ 
  goal: "text", 
  prompt: "text", 
  reasoning: "text" 
}
```

### Query Optimization Patterns
```javascript
// Efficient user strategy lookup
db.strategies.find({ userId: ObjectId("..."), status: "active" })
  .sort({ createdAt: -1 })
  .limit(10)

// Protocol filtering by chain and risk
db.protocols.find({ 
  chain: "Ethereum", 
  riskScore: { $lte: 5 },
  isActive: true 
})
.sort({ tvl: -1 })

// Performance aggregation
db.strategies.aggregate([
  { $match: { userId: ObjectId("...") } },
  { $group: {
      _id: null,
      totalInvested: { $sum: "$performance.totalInvested" },
      totalReturns: { $sum: "$performance.totalReturns" }
  }}
])
```

## Database Maintenance

### Backup Strategy
```bash
# Create backup
mongodump --db yetify --out /backups/$(date +%Y%m%d)

# Restore backup
mongorestore --db yetify /backups/20240120/yetify
```

### Data Archival
```javascript
// Archive completed strategies older than 1 year
db.strategies.updateMany(
  { 
    status: "completed",
    createdAt: { $lt: new Date(Date.now() - 365*24*60*60*1000) }
  },
  { $set: { archived: true } }
)
```

### Index Maintenance
```javascript
// Monitor index usage
db.strategies.getIndexes()
db.strategies.aggregate([{ $indexStats: {} }])

// Rebuild indexes if needed
db.strategies.reIndex()
```

## Migration Scripts

### Schema Version 1.0 → 1.1 Migration
```javascript
// Add performance tracking to existing strategies
db.strategies.updateMany(
  { performance: { $exists: false } },
  { $set: {
      "performance.totalInvested": 0,
      "performance.currentValue": 0, 
      "performance.totalReturns": 0,
      "performance.roi": 0,
      "performance.lastUpdated": new Date()
  }}
)
```

## Environment Configuration

### Development
```env
MONGODB_URI=mongodb://localhost:27017/yetify
DB_NAME=yetify
```

### Production
```env
MONGODB_URI=mongodb+srv://user:pass@cluster.mongodb.net/yetify?retryWrites=true&w=majority
DB_NAME=yetify
```

This schema supports the core functionality of the Yetify DeFi agent with proper relationships, indexes, and validation rules for optimal performance and data integrity.